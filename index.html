<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Базовый стиль, чтобы было читаемо */
        body { font-family: sans-serif; background: #0f0f0f; color: white; padding: 15px; }
        .product-card { background: #1a1a1a; border: 1px solid #333; padding: 15px; margin-bottom: 10px; border-radius: 12px; }
        .weight-badge { display: inline-block; padding: 5px 10px; background: #333; border-radius: 5px; margin: 5px 5px 0 0; cursor: pointer; font-size: 12px; }
        .weight-badge.active { background: #00ff00; color: black; font-weight: bold; }
        .total-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; padding: 20px; border-top: 2px solid #00ff00; display: none; }
        .btn-order { background: #00ff00; color: black; border: none; padding: 10px 20px; border-radius: 8px; width: 100%; font-weight: bold; }
    </style>
</head>
<body>
    <div id="catalog">Загрузка...</div>
    <div id="total-bar" class="total-bar">
        <div id="summary" style="margin-bottom: 10px;"></div>
        <button class="btn-order" onclick="sendOrder()">ОТПРАВИТЬ ЗАКАЗ</button>
    </div>

<script>
let tg = window.Telegram.WebApp;
let cart = {}; 
let inventoryData = [];

const SHEET_ID = '1cHn0Jh6Buf5seFFOq5nv1WSJwUGD9kOhrEy1HevUeFk';
const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Inventory`;

async function load() {
    const res = await fetch(URL);
    const text = await res.text();
    const rows = text.split('\n').slice(1);
    
    let html = '';
    rows.forEach((row, idx) => {
        const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, '').trim());
        if (cols[2]) {
            inventoryData.push(cols);
            html += `
                <div class="product-card">
                    <b>${cols[2]}</b><br><small>${cols[0]}</small>
                    <div id="weights-${idx}">
                        <span class="weight-badge" onclick="addToCart(${idx}, 1, this)">1g</span>
                        <span class="weight-badge" onclick="addToCart(${idx}, 5, this)">5g</span>
                        <span class="weight-badge" onclick="addToCart(${idx}, 10, this)">10g</span>
                        <span class="weight-badge" onclick="addToCart(${idx}, 20, this)">20g</span>
                    </div>
                </div>`;
        }
    });
    document.getElementById('catalog').innerHTML = html;
}

function addToCart(itemIdx, weight, el) {
    // Простая логика выбора
    const item = inventoryData[itemIdx];
    cart[item[2]] = { weight: weight, category: item[0], prices: [item[3], item[4], item[5], item[6]] };
    
    // Подсветка кнопок
    const parent = el.parentElement;
    parent.querySelectorAll('.weight-badge').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    
    updateTotal();
}

function updateTotal() {
    let summary = '';
    let total = 0;
    for (let name in cart) {
        summary += `${name}: ${cart[name].weight}g `;
    }
    if (summary) {
        document.getElementById('total-bar').style.display = 'block';
        document.getElementById('summary').innerText = summary;
    }
}

function sendOrder() {
    tg.sendData(JSON.stringify(cart));
    tg.close();
}

load();
</script>
</body>
</html>
