<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #000; color: #fff; margin: 0; padding: 10px; padding-bottom: 120px; }
        .header { text-align: center; padding: 10px 0; border-bottom: 1px solid #222; }
        .header h1 { color: #00ff00; font-size: 16px; text-transform: uppercase; letter-spacing: 2px; }
        
        /* Заголовки категорий */
        .category-title { 
            width: 100%; color: #ffd700; font-size: 14px; font-weight: bold; 
            text-transform: uppercase; margin: 20px 0 10px; padding-left: 5px;
            border-left: 3px solid #ffd700;
        }

        /* Сетка товаров */
        .catalog-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); /* 3 колонки */
            gap: 8px; 
        }

        .product-card { 
            background: #111; border: 1px solid #222; border-radius: 8px; 
            padding: 8px; display: flex; flex-direction: column; justify-content: space-between;
        }

        .product-name { font-size: 11px; font-weight: bold; margin-bottom: 8px; text-align: center; color: #eee; height: 30px; overflow: hidden; }

        .weights { display: flex; flex-direction: column; gap: 4px; }
        .w-btn { 
            background: #222; border: 1px solid #333; color: #fff; 
            padding: 6px 0; border-radius: 4px; font-size: 10px; cursor: pointer; 
        }
        .w-btn.active { background: #00ff00; color: #000; font-weight: bold; border-color: #00ff00; }

        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.9); padding: 15px; border-top: 1px solid #222; backdrop-filter: blur(10px); z-index: 100; }
        .total-info { text-align: center; margin-bottom: 10px; font-size: 16px; font-weight: bold; color: #00ff00; }
        .order-btn { background: #00ff00; color: #000; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; font-size: 14px; text-transform: uppercase; }
    </style>
</head>
<body>

    <div class="header"><h1>BND MENU</h1></div>
    <div id="catalog-container">Загрузка...</div>
    
    <div id="footer" class="footer" style="display: none;">
        <div class="total-info" id="total-sum">Итого: 0 ฿</div>
        <button class="order-btn" onclick="sendOrder()">Оформить заказ</button>
    </div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();
    let cart = {};
    let inventory = [];

    const SHEET_ID = '1cHn0Jh6Buf5seFFOq5nv1WSJwUGD9kOhrEy1HevUeFk';
    const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Inventory`;

    async function loadCatalog() {
        const res = await fetch(URL);
        const data = await res.text();
        const rows = data.split('\n').slice(1);
        let html = '';
        let currentCat = '';

        rows.forEach((row, idx) => {
            const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, '').trim());
            if (cols[2]) {
                inventory.push(cols);
                const itemIdx = inventory.length - 1;
                
                if (cols[0] !== currentCat) {
                    if (currentCat !== '') html += '</div>'; // Закрываем предыдущую сетку
                    currentCat = cols[0];
                    html += `<div class="category-title">${currentCat}</div><div class="catalog-grid">`;
                }
                
                html += `
                    <div class="product-card">
                        <div class="product-name">${cols[2]}</div>
                        <div class="weights">
                            ${cols[3] ? `<button class="w-btn" data-item="${cols[2]}" data-w="1" onclick="select(this, ${itemIdx}, 1)">1г</button>` : ''}
                            ${cols[4] ? `<button class="w-btn" data-item="${cols[2]}" data-w="5" onclick="select(this, ${itemIdx}, 5)">5г</button>` : ''}
                            ${cols[5] ? `<button class="w-btn" data-item="${cols[2]}" data-w="10" onclick="select(this, ${itemIdx}, 10)">10г</button>` : ''}
                            ${cols[6] ? `<button class="w-btn" data-item="${cols[2]}" data-w="20" onclick="select(this, ${itemIdx}, 20)">20г</button>` : ''}
                        </div>
                    </div>`;
            }
        });
        html += '</div>';
        document.getElementById('catalog-container').innerHTML = html;
    }

    function select(btn, itemIdx, weight) {
        const itemName = inventory[itemIdx][2];
        const item = inventory[itemIdx];

        // Если кнопка уже активна — отменяем выбор
        if (btn.classList.contains('active')) {
            btn.classList.remove('active');
            delete cart[itemName];
        } else {
            // Снимаем актив с других весов ЭТОГО товара
            const parent = btn.parentElement;
            parent.querySelectorAll('.w-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            let price = 0;
            if (weight === 1) price = item[3];
            if (weight === 5) price = item[4];
            if (weight === 10) price = item[5];
            if (weight === 20) price = item[6];

            cart[itemName] = { weight: weight, price: parseInt(price) || 0 };
        }

        calculateTotal();
    }

    function calculateTotal() {
        let total = 0;
        let count = 0;
        for (let id in cart) { 
            total += cart[id].price; 
            count++;
        }
        
        document.getElementById('total-sum').innerText = `Итого: ${total} ฿`;
        document.getElementById('footer').style.display = count > 0 ? 'block' : 'none';
        
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function sendOrder() {
        if (Object.keys(cart).length === 0) return;
        tg.sendData(JSON.stringify(cart));
        tg.close();
    }

    loadCatalog();
</script>
</body>
</html>