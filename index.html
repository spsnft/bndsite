<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #000; color: #fff; margin: 0; padding: 15px; padding-bottom: 100px; }
        .header { text-align: center; padding: 20px 0; border-bottom: 1px solid #222; margin-bottom: 20px; }
        .header h1 { color: #00ff00; margin: 0; font-size: 20px; text-transform: uppercase; letter-spacing: 2px; }
        .category-title { color: #ffd700; font-size: 16px; margin: 25px 0 10px; font-weight: bold; text-transform: uppercase; border-left: 3px solid #ffd700; padding-left: 10px; }
        .product-card { background: #111; border: 1px solid #222; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .product-name { font-size: 18px; font-weight: bold; margin-bottom: 5px; color: #eee; }
        .product-desc { font-size: 13px; color: #888; margin-bottom: 15px; }
        .weights { display: flex; flex-wrap: wrap; gap: 8px; }
        .w-btn { background: #222; border: 1px solid #333; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .w-btn.active { background: #00ff00; color: #000; border-color: #00ff00; font-weight: bold; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(17, 17, 17, 0.95); padding: 20px; border-top: 1px solid #222; display: none; }
        .order-btn { background: #00ff00; color: #000; border: none; padding: 15px; border-radius: 10px; width: 100%; font-weight: bold; font-size: 16px; text-transform: uppercase; }
    </style>
</head>
<body>
    <div class="header"><h1>BND MENU</h1></div>
    <div id="catalog">Загрузка товаров...</div>
    <div id="footer" class="footer">
        <button class="order-btn" onclick="sendOrder()">Отправить заказ</button>
    </div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();
    let cart = {};
    const SHEET_ID = '1cHn0Jh6Buf5seFFOq5nv1WSJwUGD9kOhrEy1HevUeFk';
    const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Inventory`;

    async function loadCatalog() {
        const res = await fetch(URL);
        const data = await res.text();
        const rows = data.split('\n').slice(1);
        let html = '';
        let currentCat = '';

        rows.forEach((row, idx) => {
            const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/"/g, '').trim());
            if (cols[2]) {
                if (cols[0] !== currentCat) {
                    currentCat = cols[0];
                    html += `<div class="category-title">${currentCat}</div>`;
                }
                html += `
                    <div class="product-card">
                        <div class="product-name">${cols[2]}</div>
                        <div class="product-desc">${cols[1]} | ${cols[8] || ''}</div>
                        <div class="weights">
                            <button class="w-btn" onclick="select(this, '${cols[2]}', 1)">1г</button>
                            <button class="w-btn" onclick="select(this, '${cols[2]}', 5)">5г</button>
                            <button class="w-btn" onclick="select(this, '${cols[2]}', 10)">10г</button>
                            <button class="w-btn" onclick="select(this, '${cols[2]}', 20)">20г</button>
                        </div>
                    </div>`;
            }
        });
        document.getElementById('catalog').innerHTML = html;
    }

    function select(btn, name, weight) {
        // Убираем активный класс у соседей
        const parent = btn.parentElement;
        parent.querySelectorAll('.w-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Добавляем в корзину
        cart[name] = { weight: weight };
        document.getElementById('footer').style.display = 'block';
        tg.HapticFeedback.impactOccurred('medium');
    }

    function sendOrder() {
        if (Object.keys(cart).length === 0) return;
        tg.sendData(JSON.stringify(cart));
        tg.close();
    }

    loadCatalog();
</script>
</body>
</html>
